<?php

namespace NTE\BogartBundle\Controller;

use Symfony\Bundle\FrameworkBundle\Controller\Controller;
use Symfony\Component\HttpFoundation\Response;
use NTE\BogartBundle\Entity\BotaniqueTaxon;

class ConvertCroissanceTaxonController extends Controller
{

	public function indexAction()
    {	
		ini_set('max_execution_time', "3600"); // (1 hour) This script can take very long to execute!!!
		
        $em = $this->getDoctrine()->getManager();
        $taxons = $em->getRepository('NTEBogartBundle:BotaniqueTaxon')->findAll();
        $mois = array('janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre');
        foreach($taxons as $taxon) {
            if ($taxon->getVieilleFloraison() != '') {
    #            $this->debug($taxon->getFloraison());
#                $this->debug(explode(',', $taxon->getFloraison()));
                $tableau = explode(',', $taxon->getVieilleFloraison());
                $t2 = "a:".count($tableau).":{";
                $i = 0;
                foreach($tableau as $t) {
                    echo "---- $t, ".$taxon->getId();
                    $this->debug(intval($t));
                    if ($t != '') {
                        $t2 .= "i:".$i.";s:".strlen($mois[intval($t)-1]).":\"".$mois[intval($t)-1]."\";";
                        $i++;
                    }
                }
                $t2 .= "}";
#                $this->debug($t2);
                $taxon->setFloraison($t2);
                $em->persist($taxon);
            }
        }
        $em->flush();
        exit();
        return new Response('Conversion terminée!');
    }
	
	private function debug($mixed) {
		echo "<pre>";
		print_r($mixed);
		echo "</pre>";	
	}

}
